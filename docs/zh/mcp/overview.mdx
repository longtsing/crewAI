---
title: '将 MCP 服务器作为 CrewAI 中的工具'
description: '了解如何使用 `crewai-tools` 库在您的 CrewAI 代理中集成 MCP 服务器作为工具。'
icon: 'plug'
mode: "wide"
---

## 概述

[模型上下文协议](https://modelcontextprotocol.io/introduction)（MCP）提供了一种标准化方式，让 AI 代理通过称为 MCP 服务器的外部服务进行通信，为 LLM 提供上下文。

CrewAI 提供了**两种方法**进行 MCP 集成：

### 🚀 **简单 DSL 集成**（推荐）

直接在代理上使用 `mcps` 字段进行无缝 MCP 工具集成。DSL 支持**字符串引用**（用于快速设置）和**结构化配置**（用于完全控制）。

#### 基于字符串的引用（快速设置）

完美适用于远程 HTTPS 服务器和 CrewAI AOP 市场：

```python
from crewai import Agent

agent = Agent(
    role="研究分析师",
    goal="研究和分析信息",
    backstory="具有外部工具访问权限的专家研究员",
    mcps=[
        "https://mcp.exa.ai/mcp?api_key=your_key",           # 外部 MCP 服务器
        "https://api.weather.com/mcp#get_forecast",          # 服务器中的特定工具
        "crewai-amp:financial-data",                         # CrewAI AOP 市场
        "crewai-amp:research-tools#pubmed_search"            # 特定 AMP 工具
    ]
)

# MCP 工具现在自动对您的代理可用！
```

#### 结构化配置（完全控制）

对连接设置、工具过滤和所有传输类型进行完全控制：

```python
from crewai import Agent
from crewai.mcp import MCPServerStdio, MCPServerHTTP, MCPServerSSE
from crewai.mcp.filters import create_static_tool_filter

agent = Agent(
    role="高级研究分析师",
    goal="使用对 MCP 连接的完全控制进行研究",
    backstory="具有高级工具访问权限的专家研究员",
    mcps=[
        # Stdio 传输用于本地服务器
        MCPServerStdio(
            command="npx",
            args=["-y", "@modelcontextprotocol/server-filesystem"],
            env={"API_KEY": "your_key"},
            tool_filter=create_static_tool_filter(
                allowed_tool_names=["read_file", "list_directory"]
            ),
            cache_tools_list=True,
        ),
        # HTTP/Streamable HTTP 传输用于远程服务器
        MCPServerHTTP(
            url="https://api.example.com/mcp",
            headers={"Authorization": "Bearer your_token"},
            streamable=True,
            cache_tools_list=True,
        ),
        # SSE 传输用于实时流传输
        MCPServerSSE(
            url="https://stream.example.com/mcp/sse",
            headers={"Authorization": "Bearer your_token"},
        ),
    ]
)
```

### 🔧 **高级：MCPServerAdapter**（用于复杂场景）

对于需要手动连接管理的高级用例，使用 `crewai-tools` 库中的 `MCPServerAdapter` 类。

我们目前支持以下传输机制：

- **Stdio**：用于本地服务器（同一机器上进程间通过标准输入/输出通信）
- **服务器发送事件 (SSE)**：用于远程服务器（通过 HTTP 从服务器到客户端的单向、实时数据流传输）
- **Streamable HTTPS**：用于远程服务器（通过 HTTPS 进行灵活、潜在双向通信，通常使用 SSE 进行服务器到客户端的流传输）

## 视频教程

观看此视频教程以获取 CrewAI MCP 集成的综合指南：

<iframe
  className="w-full aspect-video rounded-xl"
  src="https://www.youtube.com/embed/TpQ45lAZh48"
  title="CrewAI MCP 集成指南"
  frameBorder="0"
  allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
  allowFullScreen
></iframe>

## 安装

CrewAI MCP 集成需要 `mcp` 库：

```shell
# 用于简单 DSL 集成（推荐）
uv add mcp

# 用于高级 MCPServerAdapter 使用
uv pip install 'crewai-tools[mcp]'
```

## 快速开始：简单 DSL 集成

集成 MCP 服务器最简单的方法是在您的代理上使用 `mcps` 字段。您可以使用字符串引用或结构化配置。

### 使用字符串引用快速开始

```python
from crewai import Agent, Task, Crew

# 使用字符串引用创建具有 MCP 工具的代理
research_agent = Agent(
    role="研究分析师",
    goal="使用高级搜索工具查找和分析信息",
    backstory="具有多个数据源访问权限的专家研究员",
    mcps=[
        "https://mcp.exa.ai/mcp?api_key=your_key&profile=your_profile",
        "crewai-amp:weather-service#current_conditions"
    ]
)

# 创建任务
research_task = Task(
    description="研究 AI 代理框架的最新发展",
    expected_output="带有引用的综合研究报告",
    agent=research_agent
)

# 创建并运行团队
crew = Crew(agents=[research_agent], tasks=[research_task])
result = crew.kickoff()
```

### 使用结构化配置快速开始

```python
from crewai import Agent, Task, Crew
from crewai.mcp import MCPServerStdio, MCPServerHTTP, MCPServerSSE

# 创建具有结构化 MCP 配置的代理
research_agent = Agent(
    role="研究分析师",
    goal="使用高级搜索工具查找和分析信息",
    backstory="具有多个数据源访问权限的专家研究员",
    mcps=[
        # 本地 stdio 服务器
        MCPServerStdio(
            command="python",
            args=["local_server.py"],
            env={"API_KEY": "your_key"},
        ),
        # 远程 HTTP 服务器
        MCPServerHTTP(
            url="https://api.research.com/mcp",
            headers={"Authorization": "Bearer your_token"},
        ),
    ]
)
```

# 创建任务
research_task = Task(
    description="研究 AI 代理框架的最新发展",
    expected_output="带有引用的综合研究报告",
    agent=research_agent
)

# 创建并运行团队
crew = Crew(agents=[research_agent], tasks=[research_task])
result = crew.kickoff()
```

就是这样！MCP 工具会自动发现并对您的代理可用。

## MCP 引用格式

`mcps` 字段支持**字符串引用**（用于快速设置）和**结构化配置**（用于完全控制）。您可以在同一列表中混合两种格式。

### 基于字符串的引用

#### 外部 MCP 服务器

```python
mcps=[
    # 完整服务器 - 获取所有可用工具
    "https://mcp.example.com/api",

    # 使用 # 语法从服务器获取特定工具
    "https://api.weather.com/mcp#get_current_weather",

    # 带身份验证参数的服务器
    "https://mcp.exa.ai/mcp?api_key=your_key&profile=your_profile"
]
```

#### CrewAI AOP 市场

```python
mcps=[
    # 完整 AMP MCP 服务 - 获取所有可用工具
    "crewai-amp:financial-data",

    # 使用 # 语法从 AMP 服务获取特定工具
    "crewai-amp:research-tools#pubmed_search",

    # 多个 AMP 服务
    "crewai-amp:weather-service",
    "crewai-amp:market-analysis"
]
```

### 结构化配置

#### Stdio 传输（本地服务器）

非常适合作为进程运行的本地 MCP 服务器：

```python
from crewai.mcp import MCPServerStdio
from crewai.mcp.filters import create_static_tool_filter

mcps=[
    MCPServerStdio(
        command="npx",
        args=["-y", "@modelcontextprotocol/server-filesystem"],
        env={"API_KEY": "your_key"},
        tool_filter=create_static_tool_filter(
            allowed_tool_names=["read_file", "write_file"]
        ),
        cache_tools_list=True,
    ),
    # 基于 Python 的服务器
    MCPServerStdio(
        command="python",
        args=["path/to/server.py"],
        env={"UV_PYTHON": "3.12", "API_KEY": "your_key"},
    ),
]
```

#### HTTP/Streamable HTTP 传输（远程服务器）

用于通过 HTTP/HTTPS 的远程 MCP 服务器：

```python
from crewai.mcp import MCPServerHTTP

mcps=[
    # Streamable HTTP（默认）
    MCPServerHTTP(
        url="https://api.example.com/mcp",
        headers={"Authorization": "Bearer your_token"},
        streamable=True,
        cache_tools_list=True,
    ),
    # 标准 HTTP
    MCPServerHTTP(
        url="https://api.example.com/mcp",
        headers={"Authorization": "Bearer your_token"},
        streamable=False,
    ),
]
```

#### SSE 传输（实时流传输）

对于使用服务器发送事件的服务器：

```python
from crewai.mcp import MCPServerSSE

mcps=[
    MCPServerSSE(
        url="https://stream.example.com/mcp/sse",
        headers={"Authorization": "Bearer your_token"},
        cache_tools_list=True,
    ),
]
```

#### 混合引用

您可以结合字符串引用和结构化配置：

```python
from crewai.mcp import MCPServerStdio, MCPServerHTTP

mcps=[
    # 字符串引用
    "https://external-api.com/mcp",              # 外部服务器
    "crewai-amp:financial-insights",             # AMP 服务

    # 结构化配置
    MCPServerStdio(
        command="npx",
        args=["-y", "@modelcontextprotocol/server-filesystem"],
    ),
    MCPServerHTTP(
        url="https://api.example.com/mcp",
        headers={"Authorization": "Bearer token"},
    ),
]
```

### 工具过滤

结构化配置支持高级工具过滤：

```python
from crewai.mcp import MCPServerStdio
from crewai.mcp.filters import create_static_tool_filter, create_dynamic_tool_filter, ToolFilterContext

# 静态过滤（允许/阻止列表）
static_filter = create_static_tool_filter(
    allowed_tool_names=["read_file", "write_file"],
    blocked_tool_names=["delete_file"],
)

# 动态过滤（上下文感知）
def dynamic_filter(context: ToolFilterContext, tool: dict) -> bool:
    # 为某些代理角色阻止危险工具
    if context.agent.role == "代码审查员":
        if "delete" in tool.get("name", "").lower():
            return False
    return True

mcps=[
    MCPServerStdio(
        command="npx",
        args=["-y", "@modelcontextprotocol/server-filesystem"],
        tool_filter=static_filter,  # 或 dynamic_filter
    ),
]
```

## 配置参数

每种传输类型支持特定的配置选项：

### MCPServerStdio 参数

- **`command`**（必需）：要执行的命令（例如，`"python"`、`"node"`、`"npx"`、`"uvx"`）
- **`args`**（可选）：命令参数列表（例如，`["server.py"]` 或 `["-y", "@mcp/server"]`）
- **`env`**（可选）：要传递给进程的环境变量字典
- **`tool_filter`**（可选）：用于过滤可用工具的工具过滤器函数
- **`cache_tools_list`**（可选）：是否缓存工具列表以加快后续访问（默认：`False`）

### MCPServerHTTP 参数

- **`url`**（必需）：服务器 URL（例如，`"https://api.example.com/mcp"`）
- **`headers`**（可选）：用于身份验证或其他用途的 HTTP 头字典
- **`streamable`**（可选）：是否使用可流式 HTTP 传输（默认：`True`）
- **`tool_filter`**（可选）：用于过滤可用工具的工具过滤器函数
- **`cache_tools_list`**（可选）：是否缓存工具列表以加快后续访问（默认：`False`）

### MCPServerSSE 参数

- **`url`**（必需）：服务器 URL（例如，`"https://api.example.com/mcp/sse"`）
- **`headers`**（可选）：用于身份验证或其他用途的 HTTP 头字典
- **`tool_filter`**（可选）：用于过滤可用工具的工具过滤器函数
- **`cache_tools_list`**（可选）：是否缓存工具列表以加快后续访问（默认：`False`）

### 通用参数

所有传输类型都支持：
- **`tool_filter`**：过滤器函数，控制哪些工具可用。可以是：
  - `None`（默认）：所有工具都可用
  - 静态过滤器：使用 `create_static_tool_filter()` 创建允许/阻止列表
  - 动态过滤器：使用 `create_dynamic_tool_filter()` 创建上下文感知过滤
- **`cache_tools_list`**：当为 `True` 时，在第一次发现后缓存工具列表以提高后续连接的性能

## 关键功能

- 🔄 **自动工具发现**：工具被自动发现和集成
- 🏷️ **名称冲突预防**：服务器名称被前缀到工具名称
- ⚡ **性能优化**：按需连接和模式缓存
- 🛡️ **错误弹性**：优雅处理不可用的服务器
- ⏱️ **超时保护**：内置超时防止连接挂起
- 📊 **透明集成**：与现有 CrewAI 功能无缝工作
- 🔧 **完全传输支持**：Stdio、HTTP/Streamable HTTP 和 SSE 传输
- 🎯 **高级过滤**：静态和动态工具过滤能力
- 🔐 **灵活身份验证**：支持头、环境变量和查询参数

## 错误处理

MCP DSL 集成设计为健壮并优雅地处理故障：

```python
from crewai import Agent
from crewai.mcp import MCPServerStdio, MCPServerHTTP, MCPServerSSE

agent = Agent(
    role="弹性代理",
    goal="尽管服务器问题仍继续工作",
    backstory="优雅处理故障的代理",
    mcps=[
        # 字符串引用
        "https://reliable-server.com/mcp",        # 将工作
        "https://unreachable-server.com/mcp",     # 将被优雅跳过
        "crewai-amp:working-service",             # 将工作

        # 结构化配置
        MCPServerStdio(
            command="python",
            args=["reliable_server.py"],          # 将工作
        ),
        MCPServerHTTP(
            url="https://slow-server.com/mcp",     # 将优雅超时
        ),
    ]
)

# 代理将使用工作服务器的工具并为失败服务器记录警告
```

所有连接错误都被优雅处理：
- **连接故障**：记录为警告，代理继续使用可用工具
- **超时错误**：30 秒（可配置）后连接超时
- **身份验证错误**：为调试清晰记录
- **无效配置**：在代理创建时引发验证错误

## 高级：MCPServerAdapter

对于需要手动连接管理的复杂场景，使用 `crewai-tools` 库中的 `MCPServerAdapter` 类。使用 Python 上下文管理器（`with` 语句）是推荐方法，因为它自动处理启动和停止与 MCP 服务器的连接。

## 探索 MCP 集成

<CardGroup cols={2}>
  <Card title="简单 DSL 集成" icon="code">
    href="/zh/mcp/dsl-integration"
    color="#3B82F6"
  >
    **推荐**：使用简单的 `mcps=[]` 字段语法进行轻松的 MCP 集成。
  </Card>
  <Card title="Stdio 传输" icon="server">
    href="/zh/mcp/stdio"
    color="#10B981"
  >
    通过标准输入/输出连接到本地 MCP 服务器。适用于脚本和本地可执行文件。
  </Card>
  <Card title="SSE 传输" icon="wifi">
    href="/zh/mcp/sse"
    color="#F59E0B"
  >
    使用服务器发送事件集成远程 MCP 服务器以进行实时数据流传输。
  </Card>
  <Card title="Streamable HTTP 传输" icon="globe">
    href="/zh/mcp/streamable-http"
    color="#8B5CF6"
  >
    利用强大的可流式 HTTP 与远程 MCP 服务器进行稳健通信。
  </Card>
  <Card title="连接到多个服务器" icon="layer-group">
    href="/zh/mcp/multiple-servers"
    color="#EF4444"
  >
    使用单个适配器同时聚合多个 MCP 服务器的工具。
  </Card>
  <Card title="安全注意事项" icon="lock">
    href="/zh/mcp/security"
    color="#DC2626"
  >
    查看保持您的代理安全的 MCP 集成重要安全最佳实践。
  </Card>
</CardGroup>

查看此仓库以获取 CrewAI MCP 集成的完整演示和示例！👇

<Card
title="GitHub 仓库"
icon="github"
href="https://github.com/tonykipkemboi/crewai-mcp-demo"
target="_blank"
>
CrewAI MCP 演示
</Card>

## 与 MCP 保持安全

<Warning>
在将代理连接到 MCP 服务器之前，始终确保您信任该服务器。
</Warning>

#### 安全警告：DNS 重绑定攻击

如果未正确保护，SSE 传输可能容易受到 DNS 重绑定攻击。
要防止这种情况：

1. **始终验证传入 SSE 连接的 Origin 头**以确保它们来自预期的源
2. **避免将服务器绑定到所有网络接口**（0.0.0.0）在本地运行时 - 仅绑定到 localhost（127.0.0.1）
3. **为所有 SSE 连接实现适当的身份验证**

没有这些保护，攻击者可以使用 DNS 重绑定从远程网站与本地 MCP 服务器交互。

有关更多详细信息，请参阅 [Anthropic 的 MCP 传输安全文档](https://modelcontextprotocol.io/docs/concepts/transports#security-considerations)。

### 限制

*   **支持的原语**：目前，`MCPServerAdapter` 主要支持适配 MCP `工具`。
其他 MCP 原语如 `prompts` 或 `resources` 目前未通过此适配器直接集成为 CrewAI 组件。
*   **输出处理**：适配器通常处理来自 MCP 工具的主要文本输出（例如，`.content[0].text`）。复杂或多模态输出如果不符合此模式可能需要自定义处理。